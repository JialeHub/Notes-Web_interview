# 浏览器渲染与解析

## 浏览器的渲染过程

1. 首先解析收到的文档，根据文档定义构建一棵 **DOM** 树，DOM 树是由 DOM 元素及属性节点组成的。
2. 然后对 CSS 进行解析，生成 **CSSOM** 规则树。
3. 根据 DOM 树和 CSSOM 规则树**构建渲染树**。渲染树的节点被称为渲染对象，渲染对象是一个包含有颜色和大小等属性的矩形，渲染对象和 DOM 元素相对应，但这种对应关系不是一对一的，不可见的 DOM 元素不会被插入渲染树。还有一些 DOM元素对应几个可见对象，它们一般是一些具有复杂结构的元素，无法用一个矩形来描述。
4. 当渲染对象被创建并添加到树中，它们并没有位置和大小，所以当浏览器生成渲染树以后，就会根据渲染树来进行**布局**（也可以叫做**回流**）。这一阶段浏览器要做的事情是要弄清楚各个节点在页面中的确切位置和大小。通常这一行为也被称为“自动**重排**”。
5. 布局阶段结束后是**绘制**阶段，遍历渲染树并调用渲染对象的 paint 方法将它们的内容显示在屏幕上，绘制使用 UI 基础组件。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d69da20c3f84782948226798effc60a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp)

这个过程是逐步完成的，为了更好的用户体验，渲染引擎将会尽可能早的将内容呈现到屏幕上，并不会等到所有的html 都解析完成之后再去构建和布局 render 树。它是解析完一部分内容就显示一部分内容，同时，可能还在通过网络下载其余内容。



## 渲染过程中遇到 JS 文件如何处理

**JavaScript 的加载、解析与执行会阻塞文档的解析**，也就是说，在构建 DOM 时，HTML 解析器若遇到了 JavaScript，那么它会暂停文档的解析，将控制权移交给 JavaScript 引擎，等 JavaScript 引擎运行完毕，浏览器再从中断的地方恢复继续解析文档。也就是说，如果想要首屏渲染的越快，就越不应该在首屏就加载 JS 文件，这也是都建议将 script 标签放在 body 标签底部的原因。当然在当下，并不是说 script 标签必须放在底部，因为你可以给 script 标签添加 defer 或者 async 属性。



## 什么是文档的预解析？

Webkit 和 Firefox 都做了这个优化，当**执行JS脚本**时，**另一个线程解析剩下的文档**，并**加载后面需要通过网络加载的资源**。这种方式可以使资源**并行加载**从而使整体速度更快。需要注意的是，预解析并**不改变 DOM 树**，它将这个工作留给主解析过程，自己**只解析外部资源的引用**，比如外部脚本、样式表及图片。



## CSS 如何阻塞文档解析？

理论上，既然**样式表不改变 DOM 树**，也就没有必要停下文档的解析等待它们。然而，存在一个问题，JavaScript **脚本**执行时可能在文档的解析过程中**请求样式信息**，如果**样式还没有加载和解析**，脚本将得到**错误的值**，显然这将会导致很多问题；

所以如果浏览器尚**未完成 CSSOM 的下载和构建**，而我们却想在此时运行脚本，那么浏览器将**延迟** JavaScript **脚本执行**和**文档的解析**，直至其完成 CSSOM 的下载和构建。也就是说，在这种情况下，浏览器会**先下载和构建 CSSOM，然后再执行 JavaScript，最后再继续文档的解析**。



## 如何优化关键渲染路径？

为尽快完成首次渲染，我们需要最大限度减小以下三种可变因素：

- 关键**资源的数量**
- 关键**路径长度**。
- 关键**字节**的数量。

优化关键渲染路径的常规步骤如下：

- 对关键路径进行**分析**和特性描述：**资源数、字节数、长度**。
- 最大限度**减少关键资源的数量**：删除它们，**延迟**它们的下载，将它们标记为**异步**等。
- 优化关键字节数以**缩短下载时间**（往返次数）。
- 优化其余关键资源的**加载顺序**：您需要尽早下载所有关键资产，以缩短关键路径长度



## 什么情况会阻塞渲染？

首先渲染的**前提**是**生成渲染树**，所以 **HTML** 和 **CSS** 肯定会阻塞渲染。如果你想渲染的越快，你越应该降低一开始需要渲染的文件大小，并且**扁平层级**，**优化选择器**。然后当浏览器在解析到 script 标签时，会暂停构建 DOM，完成后才会从暂停的地方重新开始。也就是说，如果你想**首屏渲染的越快**，就**越不应该在首屏就加载 JS 文件**，建议将 script 标签放在 body 标签底部 或者 给 script 标签添加 defer 或者 async 属性。



