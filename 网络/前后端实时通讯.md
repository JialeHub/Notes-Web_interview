# 前后端实时通讯

## 1.WebSocket

- **优点**：WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行**全双工**通讯的协议，WebSocket 的出现就解决了半双工通信的弊端。它最大的特点是：**服务器可以向客户端主动推动消息，客户端也可以主动向服务器推送消息**，可从HTTP升级而来，浏览器和服务器只需要一次握手，就可以进行持续的，双向的数据传输，因此能显著**节约**资源和带宽
- **缺点**：
  - **兼容**性问题:不支持较低版本的IE浏览器（IE9及以下）
  - **不支持断线重连**，需要手写心跳连接的逻辑 
  - 通信机制相对**复杂**
- **原理**：客户端向 WebSocket 服务器**通知**（notify）一个带有所有**接收者ID**（recipients IDs）的**事件**（event），服务器接收后立即通知所有**活跃**的（active）客户端，只有ID在接收者ID序列中的客户端才会处理这个事件。
- **特点**：
  - 支持**双向通信**，实时性更强
  - 可以发送**文本**，也可以发送**二进制**数据
  - 建立在**TCP**协议之上，服务端的实现比较容易
  - 数据格式比较**轻量**，性能开销小，通信**高效**
  - **没有同源限制**，客户端可以与任意服务器通信
  - 协议标识符是**ws**（如果加密，则为**wss**），服务器网址就是 URL
  - 与 HTTP 协议有着良好的兼容性。默认端口也是**80和443**，并且**握手阶段采用 HTTP 协议**，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。


- // socket.html

  ```html
  <script>
      let socket = new WebSocket('ws://localhost:3000');
      socket.onopen = function () {
        socket.send('我爱你');//向服务器发送数据
      }
      socket.onmessage = function (e) {
        console.log(e.data);//接收服务器返回的数据
      }
  </script>
  ```

  // server.js

  ```javascript
  let express = require('express');
  let app = express();
  let WebSocket = require('ws');//记得安装ws
  let wss = new WebSocket.Server({port:3000});
  wss.on('connection',function(ws) {
    ws.on('message', function (data) {
      console.log(data);
      ws.send('我不爱你')
    });
  })
  ```

  

## 2.SSE：server-sent-event（event-source）

服务器使用**流信息**向服务器推送信息。严格地说，http 协议无法做到服务器主动推送信息。但是，有一种变通方法，就是**服务器向客户端声明，接下来要发送的是流信息**。也就是说，发送的不是一次性的数据包，而是一个**数据流**，会连续不断地发送过来。这时，**客户端不会关闭连接**，会一直等着服务器发过来的新的数据流，视频播放就是这样的例子。SSE 就是利用这种机制，使用流信息向浏览器推送信息。它基于 http 协议，它相对于前面两种方式来说，不需要建立过多的 http 请求，相比之下节约了资源。

**优点**：

- 只需**一次请求**，便可以**stream**的方式多次传送数据，**节约**资源和带宽
- 相对WebSocket来说**简单**易用
- 内置断线**重连**功能(retry)

**缺点**：

- 是**单向**的，只支持**服务端->客户端**的数据传送，如果客户端需要发送信息就是属于下一个 http 请求了
- **兼容性**令人担忧，IE/Edge浏览器完全不支持



## 3. AJAX轮询，短轮询和长轮询

**短轮询：** 浏览器每隔一段时间向浏览器发送 http 请求，服务器端在收到请求后，**不论是否有数据更新，都直接进行响应**。这种方式实现的即时通信，本质上还是浏览器发送请求，服务器接受请求的一个过程，通过让客户端不断的进行请求，使得客户端能够模拟实时地收到服务器端的数据的变化。这种方式的优点是比较简单，易于理解。缺点是这种方式由于需要**不断的建立 http 连接**，严重**浪费**了服务器端和客户端的**资源**。当用户增加时，服务器端的压力就会变大，这是很不合理的。

**长轮询：** 首先由客户端向服务器发起请求，当服务器收到客户端发来的请求后，服务器端**不会直接进行响应**，而是先将这个请求**挂起**，然后判断服务器端数据是否有更新。**如果有更新，则进行响应，如果一直没有数据，则到达一定的时间限制才返回**。客户端 JavaScript 响应处理函数会在处理完服务器返回的信息后，再次发出请求，重新建立连接。长轮询和短轮询比起来，它的优点是明显减少了很多不必要的 http 请求次数，相比之下节约了资源。长轮询的缺点在于，连接**挂起也会导致资源的浪费**。

- **优点**：**兼容性**良好，对标低版本IE
- **缺点**：请求中有大半是无用的请求，**浪费资源**



## 4.Flash Socket

- **缺点**：浏览器开启时flash需要用户确认、加载时间长，用户体验较差、大多数移动端浏览器不支持flash，为重灾区
- **优点**： 兼容低版本浏览器



## 5. 永久帧（ forever iframe）

- 缺点： iframe会产生进度条一直存在的问题，用户体验差
- 优点：兼容低版本IE浏览器



**目前主流的方案**：

**性能**： **WebSocket > 长连接（SEE） > 长轮询 > 短轮询**

**兼容性**：**短轮询 > 长轮询 > 长连接（SEE） > WebSocket**
