#  网络安全

## 1.XSS 跨站脚本攻击

Cross-site scripting 攻击者在目标网站植入恶意脚本。

类型：
- **存储型/持久型**：注入服务器，服务端的安全漏洞
- **反射型/非持久型**：注入URL，服务端的安全漏洞
- **基于DOM**：被执行的恶意脚本会修改页面脚本结构，前端JavaScript的安全漏洞

XSS的注入点：HTML的节点内容或属性、HTML的节点内容或属性、富文本

攻击步骤：

- **存储型**：这种攻击常⻅于带有⽤户保存数据的⽹站功能，如论坛发帖、商品评论、⽤户私信等。

  1. 攻击者将恶意代码**提交**到⽬标⽹站的**数据库**中。
  2. **⽤户打开**⽬标⽹站时，⽹站服务端将**恶意代码从数据库取出**，**拼接**在 HTML 中**返回给浏览器**。
  3. ⽤户浏览器接收到响应后**解析执⾏**，混在其中的恶意代码也被执⾏。
  4. 恶意代**码窃**取⽤户数据并**发送到攻击者的⽹站**，或者**冒充**⽤户的⾏为，调⽤⽬标⽹站接⼝**执⾏**攻击者指定的操作。

- **反射型**：常⻅于通过 URL 传递参数的功能，如⽹站搜索、跳转等。 由于需要⽤户主动打开恶意的 URL 才能⽣效，攻击者往往会结合多种⼿段诱导⽤户点击。

  1. 攻击者**构造出特殊的 URL**，其中包含恶意代码。

  2. **⽤户打开**带有恶意代码的 URL 时，⽹站服务端将恶意代码从 URL 中取出，**拼接**在 HTML 中**返回给浏览器**。
  
  3. ⽤户浏览器接收到响应后**解析**执⾏，混在其中的恶意代码也被执⾏。
  
  4. 恶意代**码窃**取⽤户数据并**发送到攻击者的⽹站**，或者**冒充**⽤户的⾏为，调⽤⽬标⽹站接⼝**执⾏**攻击者指定的操作。
  
- **Dom型**  ：取出和执⾏恶意代码由浏览器端完成，属于前端JavaScript ⾃身的安全漏洞
  
  1. 攻击者构**造出特殊的 URL**，其中包含恶意代码。
  
  2. **⽤户打开**带有恶意代码的 URL。
  
  3. ⽤户浏览器接收到响应后解析执⾏，**前端 JavaScript 取出 URL** 中的恶意代码并执⾏。
  
  4. 恶意代**码窃**取⽤户数据并**发送到攻击者的⽹站**，或者**冒充**⽤户的⾏为，调⽤⽬标⽹站接⼝**执⾏**攻击者指定的操作。
  
  

攻击后果：获取页面的数据，如DOM、cookie、localStorage；DOS攻击，发送合理请求，占用服务器资源，从而使用户无法访问服务器；破坏页面结构；流量劫持（将链接指向某网站）；

防御：
- **表单验证**、对用户输入内容和服务端返回内容进行**过滤和转译**，**避免拼接** HTML；Vue/React 技术栈，**避免使用 v-html** / dangerouslySetInnerHTML

- 设置**CSP**(Content-Security-Policy)响应头：**白名单**制度，开发者明确告诉客户端，哪些外部资源可以加载和执行

- 设置**X-XSS-Protection**响应头：防止反射型/非持久型注入URL，0: 禁止XSS过滤、1 启用 XSS 过滤（通常在浏览器中默认）、1; mode=block 启用XSS保护，并在检查到XSS攻击时，停止渲染页面

- 通过开源的**第三方库**来实现，类似的有js-xss，防止**富文本注入**

- 开启**Http-Only cookie**，禁止 JavaScript 读取某些敏感 Cookie

  


## 2.CSRF/XSRF 跨站请求伪造

攻击者盗用/冒充了你的身份，以你的名义进行恶意请求。

类型：

- GET型：如在页面的某个 img 中发起一个 get 请求
- POST型：通过自动提交表单到恶意网站
- 链接型：需要诱导用户点击链接

防御：

- **同源检测**：Access-Control-Allow-Origin 设置**跨域白名单**、判断请求头 **Referer 来源**
- **CSRF Token 校验** / 请求头加上自定义属性验证 （黑客并不能拿到和看到`cookie`里的内容，可对cookie进行Hash加密，或者**双重cookie验证**，把cookies添加到URL的参数中，后端比对）
- **Samesite Cookie**属性：为Set-Cookie响应头新增Samesite属性
- 验证码、密码
- 使用post而不是get请求(但依然可伪造)



## 3.iframe

a.如何让自己的网站不被其他网站的 iframe 引用：top.location ?== self.location

b.如何禁用，被使用的 iframe 对当前网站某些操作 。

c.ClickJacking（点击劫持）:一般会利用透明 iframe 覆盖原网页诱导用户进行某些操 作达成目的。

防御：
- 为 iframe 设置 sandbox 属性，通过它可以对iframe的行为进行各种限制，充分实现“最小权限“原则
- 在HTTP投中加入 X-FRAME-OPTIONS 属性，此属性控制页面是否可被嵌入 iframe 中【DENY：不能被所有网站嵌套或加载；SAMEORIGIN：只能被同域网站嵌套或加载；ALLOW-FROM URL：可以被指定网站嵌套或加载、判断当前网页是否被 iframe 嵌套。



## 4.HSTS（HTTP严格传输安全）

![img](https://pic1.zhimg.com/80/v2-ae9f8ef4007bf90220f91a4e5a39c594_720w.jpg)

响应头的 `Strict-Transport-Security`

网站接受从 HTTP 请求跳转到 HTTPS 请求的做法，例如我们输入“http://www.baidu.com”或“www.baidu.com”最终都会被302重定向到“https://www.baidu.com”。这就存在安全风险，当我们第一次通过 HTTP 或域名进行访问时，302重定向有可能会被劫持，篡改成一个恶意或钓鱼网站。 HSTS：通知浏览器此网站禁止使用 HTTP 方式加载，浏览器应该自动把所有尝试使用 HTTP 的请 求自动替换为 HTTPS 进行请求。用户首次访问时并不受 HSTS 保护，因为第一次还未形成链接。 我们可以通过 浏览器预置HSTS域名列表 或 将HSTS信息加入到域名系统记录中，来解决第一次访 问的问题。



## 5.opener（新标签防止恶意跳转）

a标签

```html
<a target="_blank" href="" rel="noopener noreferrer nofollow">a标签跳转url</a>
<!--
  通过 rel 属性进行控制：
  noopener：会将 window.opener 置空，从而源标签页不会进行跳转（存在浏览器兼容问题）
  noreferrer：兼容老浏览器/火狐。禁用HTTP头部Referer属性（后端方式）。
  nofollow：SEO权重优化
-->
```

window.open()

```html
<button onclick='openurl("http://www.baidu.com")'>click跳转</button>
function openurl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}
```



## 6.网络劫持

- **CDN劫持**：出于性能考虑，前端应用通常会把一些静态资源存放到CDN（Content Delivery Networks）上面，例如 js 脚本和 style 文件。这么做可以显著提高前端应用的访问速度，但与此同时却也隐含了一个新的安全风险。如果攻击者劫持了CDN，或者对CDN中的资源进行了污染，攻击者可以肆意篡改我们的前端页面，对用户实施攻击。
		静态资源完整性校验：现在的CDN以支持SRI为荣，script 和 link 标签有了新的属性 integrity，这个属性是为了防止校验资源完整性来判断是否被篡改。它通过验证获取文件的哈希值是否和你提供的哈希值一样来判断资源是否被篡改，使用 SRI 需要两个条件：一是要保证 资源同域 或开启跨域，二是在中 提供签名 以供校验。
	
	```html
	<script type="text/javascript" src="xxx" integrity="sha256-xxx sha384-yyy" crossorigin="anonymous"/>
	```
	
- **DNS劫持**：DNS 劫持是违法的行为， 目前 DNS 劫持已被监管，现在很少见 DNS 劫持

  - DNS强制解析: 修改运行商的 DNS 记录，重定向到其他网站。
  - 302跳转的⽅式: 通过监控⽹络出⼝的流量，分析判断哪些内容是可以进⾏劫持处理的,再对劫持的内存发起302跳转的回复，引导⽤户获取内容

- **HTTP劫持**：前提有 HTTP 请求。因 HTTP 是明文传输，运营商便可借机修改 HTTP 响应内容（如加广告）。预防：全站 HTTPS



## 7.错误的内容推断

文件上传类型校验失败后，导致恶意的JS文件上传后，浏览器 Content-Type Header 的默认解析为可 执行的JS 文件

预防：设置X-Content-Type-Options响应头



## 8.第三方依赖包

减少对第三方依赖包的使用



## 9.本地存储数据

避免重要的用户信息存在浏览器缓存中

Samesite Cookie属性：为Set-Cookie响应头新增Samesite属性

开启Http Only cookie，禁止 JavaScript 读取某些敏感 Cookie



## 10.中间人攻击

常见方式：
- 嗅探：抓包
- 数据包注入、篡改
- 数据流量劫持、会话劫持
- SSL剥离
- DNS欺骗
- ARP欺骗
- 代理服务器

攻击过程：

1. 客户端发送请求到服务端，请求被中间⼈截获
2. 服务器向客户端发送公钥
3. 中间⼈截获公钥，保留在⾃⼰⼿上。然后⾃⼰⽣成⼀个**伪造的**公钥，发给客户端
4. 客户端收到伪造的公钥后，⽣成加密hash值发给服务器
5. 中间⼈获得加密hash值，⽤⾃⼰的私钥解密获得真秘钥,同时⽣成假的加密hash值，发给服务器
6. 服务器⽤私钥解密获得假密钥,然后加密数据传输给客户端

预防：
- 用可信的第三方CA厂商
- 不下载未知来源的证书，不要去下载一些不安全的文件
- 确认你访问的URL是HTTPS的，确保网站使用了SSL，确保禁用一些不安全的SSL，只开启：TLS1.1，TLS1.2
- 不要使用公用网络发送一些敏感的信息
- 不要去点击一些不安全的连接或者恶意链接或邮件信息
- 不连接不明WIFI



## 11.sql 注入

把Sql语句通过表单提交给服务器，服务器就会执行那条恶意Sql语句

预防：过滤字符、参数化查询，避免拼接Sql语句



## 12.DDOS（分布式拒绝服务）

常见：
- SYN攻击：利用TCP三次握手的SYN Timeout超时(第三次不握手，让服务器挂着)。预防：缩短SYN Timeout、设置SYN Cookies、多连接队列
- 洪水攻击：利用傀儡机（肉鸡）大量向服务器请求。预防：防火墙、ip过滤、ip请求频率限制、验证码、CDN缓解、




## 13.前端数据安全

- 反爬虫：
  - font-face拼接
  - background 拼接
  - 伪元素隐藏
  - 元素定位覆盖式
  - iframe 异步加载
  - 验证码
  - ip请求频率限制
  
- 定期请第三方机构做安全性测试，漏洞扫描
- 使用第三方开源库做上线前的安全测试，可以考虑融合到CI中
- code review 保证代码质量
- 对第三方包和库做检测：NSP(Node Security Platform)，Snyk

